<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Redis的Stream消息队列应用 | Apong&#39;s Blog | 当你快坚持不住的时候，困难也快坚持不住了</title>

  
  <meta name="author" content="Apong">
  

  
  <meta name="description" content="在异步秒杀下单中，用Stream替代JDK的BlockingQueue">
  

  
  <meta name="keywords" content="博客, 知识分享, 开源">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Redis的Stream消息队列应用"/>

  <meta property="og:site_name" content="Apong&#39;s Blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Apong&#39;s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Apong&#39;s Blog</a>
    </h1>
    <p class="site-description">当你快坚持不住的时候，困难也快坚持不住了</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/archives/">归档</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/categories/daily/">每日总结</a></li>
      
        <li><a target="_blank" rel="noopener" href="https://github.com/blueapong">Github</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Redis的Stream消息队列应用</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2024/04/07/240407/" rel="bookmark">
        <time class="entry-date published" datetime="2024-04-07T08:55:47.000Z">
          2024-04-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="熟悉Stream"><a href="#熟悉Stream" class="headerlink" title="熟悉Stream"></a>熟悉Stream</h1><h2 id="独立消费者"><a href="#独立消费者" class="headerlink" title="独立消费者"></a>独立消费者</h2><p><strong>发布消息</strong></p>
<p><code>XADD KEY [NOMKSTREAM] *|ID field value [field value ...] </code></p>
<p>添加一条消息到 key 的队列中去，如果不存在则创建队列</p>
<p>*：自动生成id</p>
<p>ID：自定义id，需遵循时间戳-序号的格式</p>
<p>field，value：消息键值对，允许一条消息有多个键值对，类似hash</p>
<p>NOMKSTREAM：如果队列不存在，不会创建</p>
<p><strong>订阅消息</strong></p>
<p><code>XREAD COUNT count BLOCK milliseconds STREAMS key [key ...] ID [ID ...]</code></p>
<p>可以从多个stream中读取从ID往后的count条消息，如果暂时没有则等待xx毫秒</p>
<p>COUNT：读取数量</p>
<p>BLOCK：等待时间</p>
<p>ID：消息起始ID，可以传特殊值 0：第一个，$：最新消息。</p>
<blockquote>
<p>$：是最新消息，返回开启了阻塞等待后的第一条消息，存在漏读的问题，往后的二三条都读不到，如果COUNT为1。</p>
</blockquote>
<p><strong>特点</strong></p>
<ol>
<li>消息可以追溯，不是读完就消失了</li>
<li>一条消息可以被多个消费者读取</li>
<li>可以阻塞读取</li>
<li>有消息漏读的风险</li>
</ol>
<h2 id="消费者组"><a href="#消费者组" class="headerlink" title="消费者组"></a><strong>消费者组</strong></h2><p>将消息和消费者分组，每一组的消息由组内的消费者消费</p>
<p>特点：</p>
<ol>
<li>消息分流，同组的信息由多个消费者同时处理</li>
<li>消息标识，消费者组会维护一个标识，记录着最后一个被处理的消息，确保每次读取未处理的</li>
<li>消息确认，如果被读取的消息没有确认完成，会存在每个消费者的pending-list，供每个消费者继续消费。</li>
</ol>
<h3 id="创建消费者组"><a href="#创建消费者组" class="headerlink" title="创建消费者组"></a>创建消费者组</h3><p><code>XGROUP CREATE key groupName MKSTREAM</code></p>
<p>给stream创建一个消费者组，如果Stream不存在则自动创建</p>
<p>key：队列的key</p>
<p>groupName：消费者组名</p>
<p>MKSTREAM：自动创建队列</p>
<h3 id="消费者组读取消息"><a href="#消费者组读取消息" class="headerlink" title="消费者组读取消息"></a>消费者组读取消息</h3><p><code>XREADGROUP GROUP group consumer COUNT count BLOCK mills STREAMS key ID</code></p>
<p>先写命令 <code>XREADGROUP GROUP</code>，再写 <code>group consumer</code> 组名和消费者名，再写读取数量和等待时间，最后写队列key和起始消息ID</p>
<p>ID有两类特殊值：</p>
<ol>
<li>“&gt;”，从下一个未消费的消息开始</li>
<li>其他：从各自消费者的pending-list中取，例如0，表示list中的第一个消息。</li>
</ol>
<h3 id="确认消息"><a href="#确认消息" class="headerlink" title="确认消息"></a>确认消息</h3><p>xack </p>
<h1 id="异步秒杀应用Stream消息队列"><a href="#异步秒杀应用Stream消息队列" class="headerlink" title="异步秒杀应用Stream消息队列"></a>异步秒杀应用Stream消息队列</h1><p>准备工作：</p>
<ol>
<li>创建消费者组，自动创建队列</li>
</ol>
<p>书写lua代码：</p>
<ol>
<li>判断是否有秒杀资格</li>
<li>如果有则加入消息队列</li>
</ol>
<p>书写Java代码：</p>
<ol>
<li>持续监听下单消息</li>
<li>取出下单消息 xreadgroup</li>
<li>如果不存在，则继续监听</li>
<li>如果处理失败，就转入pending-list处理</li>
<li>取出待处理消息 xreadgroup</li>
<li>如果处理失败，继续取出处理，直到处理完毕</li>
<li>最后确认消息 xack streamKey groupName messageId</li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Redis/">Redis</a>, <a href="/categories/Redis/Stream/">Stream</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Redis-Stream/">Redis Stream</a><a href="/tags/消息队列/">消息队列</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 Apong
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>